"use strict";

// Helper function for class properties
var _cc = (function () {
  function defineProperties(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];
      descriptor.enumerable = descriptor.enumerable || false;
      descriptor.configurable = true;
      if ("value" in descriptor) descriptor.writable = true;
      Object.defineProperty(target, descriptor.key, descriptor);
    }
  }
  return function (Constructor, protoProps, staticProps) {
    if (protoProps) defineProperties(Constructor.prototype, protoProps);
    if (staticProps) defineProperties(Constructor, staticProps);
    return Constructor;
  };
})();

function _ccc(instance, Constructor) {
  if (!(instance instanceof Constructor)) {
    throw new TypeError("Cannot call a class as a function");
  }
}

(function (window) {
  // Hitung tinggi segitiga
  function triangleHeight(angle, size) {
    var tanValue = Math.tan(0.017453 * Math.abs(angle));
    return Math.ceil(size * tanValue);
  }

  // Konversi hex -> RGB
  function hexToRgb(hex) {
    var c;
    if (/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)) {
      c = hex.substring(1).split("");
      if (c.length === 3) {
        c = [c[0], c[0], c[1], c[1], c[2], c[2]];
      }
      c = "0x" + c.join("");
      return {
        r: (c >> 16) & 255,
        g: (c >> 8) & 255,
        b: c & 255,
      };
    }
    return { r: 0, g: 0, b: 0 };
  }

  // Particle Class
  var Particle = (function () {
    function Particle(color, quadrant, options) {
      _ccc(this, Particle);
      this.o = options;
      this.r = hexToRgb(color);
      this.d = this.randomDirection();
      this.h = this.randomShape();
      this.s = Math.abs(this.randomRange(this.o.size));
      this.setStartPosition(quadrant);

      this.vx = this.randomRange(this.o.speed.x) * this.randomDirection();
      this.vy = this.randomRange(this.o.speed.y) * this.randomDirection();
    }

    _cc(Particle, [
      {
        key: "setStartPosition",
        value: function (quadrant) {
          var i = this.getRandomPosition();
          if (quadrant === 3) {
            this.x = i.x + i.halfWidth;
            this.y = i.y;
          } else if (quadrant === 2) {
            this.x = i.x;
            this.y = i.y + i.halfHeight;
          } else if (quadrant === 1) {
            this.x = i.x + i.halfWidth;
            this.y = i.y + i.halfHeight;
          } else {
            this.x = i.x;
            this.y = i.y;
          }
        },
      },
      {
        key: "getRandomPosition",
        value: function () {
          var halfWidth = this.o.c.w / 2,
            halfHeight = this.o.c.h / 2;
          return {
            x: Math.random() * halfWidth,
            y: Math.random() * halfHeight,
            halfHeight: halfHeight,
            halfWidth: halfWidth,
          };
        },
      },
      {
        key: "randomRange",
        value: function (range) {
          if (range.min === range.max) return range.min;
          var diff = range.max - range.min;
          return Math.random() * diff + range.min;
        },
      },
      {
        key: "randomDirection",
        value: function () {
          return Math.random() > 0.5 ? 1 : -1;
        },
      },
      {
        key: "randomShape",
        value: function () {
          return this.o.shapes[
            Math.floor(Math.random() * this.o.shapes.length)
          ];
        },
      },
      {
        key: "toRgba",
        value: function (rgb, alpha) {
          return "rgba(" + rgb.r + ", " + rgb.g + ", " + rgb.b + ", " + alpha + ")";
        },
      },
      {
        key: "animate",
        value: function (ctx, width, height) {
          // Pulse size
          if (this.o.size.pulse) {
            this.s += this.o.size.pulse * this.d;
            if (this.s > this.o.size.max || this.s < this.o.size.min) {
              this.d *= -1;
            }
            this.s = Math.abs(this.s);
          }

          // Movement
          this.x += this.vx;
          this.y += this.vy;

          if (this.x < 0) {
            this.vx *= -1;
            this.x += 1;
          } else if (this.x > width) {
            this.vx *= -1;
            this.x -= 1;
          }
          if (this.y < 0) {
            this.vy *= -1;
            this.y += 1;
          } else if (this.y > height) {
            this.vy *= -1;
            this.y -= 1;
          }

          // Draw particle
          ctx.beginPath();
          if (this.o.blending && this.o.blending !== "none") {
            ctx.globalCompositeOperation = this.o.blending;
          }

          var colorCenter = this.toRgba(this.r, this.o.opacity.center);
          var colorEdge = this.toRgba(this.r, this.o.opacity.edge);

          var radius =
            this.h === "c"
              ? this.s / 2
              : this.h === "t"
              ? 0.577 * this.s
              : this.h === "s"
              ? 0.707 * this.s
              : this.s;

          var gradient = ctx.createRadialGradient(
            this.x,
            this.y,
            0.01,
            this.x,
            this.y,
            radius
          );
          gradient.addColorStop(0, colorCenter);
          gradient.addColorStop(1, colorEdge);

          ctx.fillStyle = gradient;

          var r = Math.abs(this.s / 2);

          if (this.h === "c") {
            ctx.arc(this.x, this.y, r, 0, 2 * Math.PI, false);
          } else if (this.h === "s") {
            ctx.moveTo(this.x - r, this.y - r);
            ctx.lineTo(this.x + r, this.y - r);
            ctx.lineTo(this.x + r, this.y + r);
            ctx.lineTo(this.x - r, this.y + r);
          } else if (this.h === "t") {
            var v = triangleHeight(30, r),
              g = this.y + v;
            ctx.moveTo(this.x - r, g);
            ctx.lineTo(this.x + r, g);
            ctx.lineTo(this.x, this.y - 2 * v);
          }

          ctx.closePath();
          ctx.fill();
        },
      },
    ]);

    return Particle;
  })();

  // Finisher Header Class
  var FinisherHeader = (function () {
    function FinisherHeader(options) {
      var self = this;
      _ccc(this, FinisherHeader);

      this.c = document.createElement("canvas");
      this.x = this.c.getContext("2d");
      this.c.setAttribute("id", "finisher-canvas");

      this.getTarget(options.className).appendChild(this.c);

      var resizeTimeout;
      window.addEventListener(
        "resize",
        function () {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(self.resize.bind(self), 150);
        },
        false
      );

      this.init(options);
      window.requestAnimationFrame(this.animate.bind(this));
    }

    _cc(FinisherHeader, [
      {
        key: "getTarget",
        value: function (className) {
          var target = document.getElementsByClassName(className || "finisher-header");
          if (!target.length) throw new Error("No .finisher-header element found");
          return target[0];
        },
      },
      {
        key: "resize",
        value: function () {
          var target = this.getTarget(this.o.className);
          this.o.c = { w: target.clientWidth, h: target.clientHeight };

          this.c.width = this.o.c.w;
          this.c.height = this.o.c.h;

          var skewValue = triangleHeight(this.o.skew, this.o.c.w / 2);
          var transform =
            "skewY(" + this.o.skew + "deg) translateY(-" + skewValue + "px)";

          this.c.setAttribute(
            "style",
            "position:absolute;z-index:-1;top:0;left:0;right:0;bottom:0;" +
              "-webkit-transform:" +
              transform +
              ";transform:" +
              transform +
              ";outline:1px solid transparent;" +
              "background-color:rgba(" +
              this.bc.r +
              "," +
              this.bc.g +
              "," +
              this.bc.b +
              ",1);"
          );
        },
      },
      {
        key: "init",
        value: function (options) {
          this.o = options;
          this.bc = hexToRgb(this.o.colors.background);
          this.ps = [];
          this.resize();
          this.createParticles();
        },
      },
      {
        key: "createParticles",
        value: function () {
          var i = 0;
          this.ps = [];
          this.o.ac =
            window.innerWidth < 600 && this.o.count > 5
              ? Math.round(this.o.count / 2)
              : this.o.count;

          for (var s = 0; s < this.o.ac; s++) {
            var h = s % 4;
            var particle = new Particle(this.o.colors.particles[i], h, this.o);
            i++;
            if (i >= this.o.colors.particles.length) i = 0;
            this.ps[s] = particle;
          }
        },
      },
      {
        key: "animate",
        value: function () {
          window.requestAnimationFrame(this.animate.bind(this));
          this.x.clearRect(0, 0, this.o.c.w, this.o.c.h);

          for (var i = 0; i < this.o.ac; i++) {
            this.ps[i].animate(this.x, this.o.c.w, this.o.c.h);
          }
        },
      },
    ]);

    return FinisherHeader;
  })();

  window.FinisherHeader = FinisherHeader;
})(window);
